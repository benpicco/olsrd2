/*
 * test_packetbb_conversion.c
 *
 *  Created on: Apr 23, 2012
 *      Author: rogge
 */

#include "common/common_types.h"
#include "packetbb/pbb_conversion.h"
#include "../cunit.h"

static const uint32_t _table[256] = {
  0x00000000,0x00000001,0x00000001,0x00000001,0x00000001,0x00000001,0x00000001,0x00000001,
  0x00000001,0x00000002,0x00000002,0x00000002,0x00000002,0x00000003,0x00000003,0x00000003,
  0x00000003,0x00000004,0x00000004,0x00000005,0x00000005,0x00000006,0x00000006,0x00000007,
  0x00000007,0x00000008,0x00000009,0x0000000a,0x0000000b,0x0000000c,0x0000000d,0x0000000e,
  0x0000000f,0x00000011,0x00000013,0x00000015,0x00000017,0x00000019,0x0000001b,0x0000001d,
  0x0000001f,0x00000023,0x00000027,0x0000002a,0x0000002e,0x00000032,0x00000036,0x0000003a,
  0x0000003e,0x00000046,0x0000004e,0x00000055,0x0000005d,0x00000065,0x0000006d,0x00000075,
  0x0000007d,0x0000008c,0x0000009c,0x000000ab,0x000000bb,0x000000cb,0x000000da,0x000000ea,
  0x000000fa,0x00000119,0x00000138,0x00000157,0x00000177,0x00000196,0x000001b5,0x000001d4,
  0x000001f4,0x00000232,0x00000271,0x000002af,0x000002ee,0x0000032c,0x0000036b,0x000003a9,
  0x000003e8,0x00000465,0x000004e2,0x0000055f,0x000005dc,0x00000659,0x000006d6,0x00000753,
  0x000007d0,0x000008ca,0x000009c4,0x00000abe,0x00000bb8,0x00000cb2,0x00000dac,0x00000ea6,
  0x00000fa0,0x00001194,0x00001388,0x0000157c,0x00001770,0x00001964,0x00001b58,0x00001d4c,
  0x00001f40,0x00002328,0x00002710,0x00002af8,0x00002ee0,0x000032c8,0x000036b0,0x00003a98,
  0x00003e80,0x00004650,0x00004e20,0x000055f0,0x00005dc0,0x00006590,0x00006d60,0x00007530,
  0x00007d00,0x00008ca0,0x00009c40,0x0000abe0,0x0000bb80,0x0000cb20,0x0000dac0,0x0000ea60,
  0x0000fa00,0x00011940,0x00013880,0x000157c0,0x00017700,0x00019640,0x0001b580,0x0001d4c0,
  0x0001f400,0x00023280,0x00027100,0x0002af80,0x0002ee00,0x00032c80,0x00036b00,0x0003a980,
  0x0003e800,0x00046500,0x0004e200,0x00055f00,0x0005dc00,0x00065900,0x0006d600,0x00075300,
  0x0007d000,0x0008ca00,0x0009c400,0x000abe00,0x000bb800,0x000cb200,0x000dac00,0x000ea600,
  0x000fa000,0x00119400,0x00138800,0x00157c00,0x00177000,0x00196400,0x001b5800,0x001d4c00,
  0x001f4000,0x00232800,0x00271000,0x002af800,0x002ee000,0x0032c800,0x0036b000,0x003a9800,
  0x003e8000,0x00465000,0x004e2000,0x0055f000,0x005dc000,0x00659000,0x006d6000,0x00753000,
  0x007d0000,0x008ca000,0x009c4000,0x00abe000,0x00bb8000,0x00cb2000,0x00dac000,0x00ea6000,
  0x00fa0000,0x01194000,0x01388000,0x0157c000,0x01770000,0x01964000,0x01b58000,0x01d4c000,
  0x01f40000,0x02328000,0x02710000,0x02af8000,0x02ee0000,0x032c8000,0x036b0000,0x03a98000,
  0x03e80000,0x04650000,0x04e20000,0x055f0000,0x05dc0000,0x06590000,0x06d60000,0x07530000,
  0x07d00000,0x08ca0000,0x09c40000,0x0abe0000,0x0bb80000,0x0cb20000,0x0dac0000,0x0ea60000,
  0x0fa00000,0x11940000,0x13880000,0x157c0000,0x17700000,0x19640000,0x1b580000,0x1d4c0000,
  0x1f400000,0x23280000,0x27100000,0x2af80000,0x2ee00000,0x32c80000,0x36b00000,0x3a980000,
  0x3e800000,0x46500000,0x4e200000,0x55f00000,0x5dc00000,0x65900000,0x6d600000,0x75300000,
  0x7d000000,0x8ca00000,0x9c400000,0xabe00000,0xbb800000,0xcb200000,0xdac00000,0xea600000,
};

static void
clear_elements(void) {
}

static void
test_decoding(void) {
  uint32_t encoded, decoded;

  START_TEST();

  for (encoded = 1; encoded < 256; encoded++) {
    decoded = pbb_timetlv_decode(encoded);
    CHECK_TRUE(decoded == _table[encoded], "decode(%u) != %u", encoded, decoded);
  }

  END_TEST();
}

static void
test_encoding_exact(void) {
  uint32_t encoded, decoded, i;

  START_TEST();

  for (i=1; i<256; i++) {
    if (_table[i] == _table[i-1]) {
      continue;
    }

    decoded = _table[i];
    encoded = pbb_timetlv_encode(decoded);

    CHECK_TRUE(encoded == i, "encode(%u) != %u", decoded, i);
  }

  END_TEST();
}

static void
_do_average_test(uint32_t decoded) {
  uint32_t encoded;

  encoded = pbb_timetlv_encode(decoded);

  CHECK_TRUE(_table[encoded] > decoded, "encode(%u)=%u, decode(%u)=%u, %u <= %u",
      decoded, encoded,
      encoded, _table[encoded],
      _table[encoded-1], decoded);
  CHECK_TRUE(_table[encoded-1] < decoded, "encode(%u)=%u, decode(%u-1)=%u, %u >= %u",
      decoded, encoded,
      encoded, _table[encoded-1],
      _table[encoded-1], decoded);
}

static void
test_encoding_average(void) {
  uint32_t decoded;

  int i,j;


  START_TEST();

  for (i=1; i<256; i++) {
    if (_table[i] - _table[i-1] < 2) {
      continue;
    }

    for (j = 1; j<5; j++) {
      decoded = _table[i] - j;

      if (_table[i-1] < decoded) {
        _do_average_test(decoded);
      }
    }
    for (j = 1; j<5; j++) {
      decoded = _table[i-1] + j;

      if (_table[i] > decoded) {
        _do_average_test(decoded);
      }
    }
  }
  END_TEST();
}

int main(int argc __attribute__ ((unused)), char **argv __attribute__ ((unused))) {
  BEGIN_TESTING();

  test_decoding();
  test_encoding_exact();
  test_encoding_average();

  FINISH_TESTING();
  return total_fail;
}
